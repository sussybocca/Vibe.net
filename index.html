<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vibe.net</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; }
  .page { display: none; padding: 20px; }
  .page.active { display: block; }
  #server-grid, #my-servers { display: flex; flex-wrap: wrap; gap: 10px; }
  .server-card { border: 1px solid #ccc; padding: 10px; cursor: pointer; width: 150px; text-align: center; }
  .editor-wrapper { height: 400px; border: 1px solid #ccc; margin-bottom: 10px; }
  #file-tabs button { margin-right: 5px; }
  #feedback-tab textarea { width: 100%; height: 80px; margin-bottom: 5px; }
  #plane-ui { margin-top: 10px; }
  .red-button { background-color: red; color: white; margin-right: 5px; padding: 5px 10px; }
</style>
</head>
<body>

<!-- Header -->
<div id="header">
  <h1>Vibe.net</h1>
  <button id="profile-btn">Profile</button>
</div>

<!-- Home Page -->
<div id="home-page" class="page active">
  <h2>All Servers</h2>
  <input type="text" id="server-search" placeholder="Search servers..." style="padding:5px; width:100%; max-width:400px; margin-bottom: 10px;">
  <div id="server-grid"></div>
</div>

<!-- Profile Page -->
<div id="profile-page" class="page">
  <h2>My Profile</h2>
  <div id="auth-container"></div>
  <hr>
  <button id="create-server-btn">Create New Server</button>
  <h3>My Servers:</h3>
  <div id="my-servers"></div>
  <button id="back-home">Back to Home</button>
</div>

<!-- Editor Page -->
<div id="editor-page" class="page">
  <h2>Server Editor</h2>
  <div id="editor-container">
    <!-- Editor Tabs -->
    <div id="editor-tabs">
      <button data-editor="monaco">Monaco</button>
      <button data-editor="codemirror">CodeMirror</button>
      <button data-editor="vscode">VS Code</button>
    </div>
    <!-- File Management -->
    <div id="file-management">
      <button id="create-file">New File</button>
      <button id="delete-file">Delete File</button>
      <button id="rename-file">Rename File</button>
    </div>
    <div id="file-tabs"></div>
    <!-- Editors -->
    <div id="monaco-editor" class="editor-wrapper"></div>
    <div id="codemirror-editor" class="editor-wrapper"></div>
    <div id="vscode-editor" class="editor-wrapper"></div>
    <!-- Feedback -->
    <div id="feedback-tab">
      <h3>Server Feedback</h3>
      <div id="feedback-list"></div>
      <textarea id="feedback-input" placeholder="Write your feedback..."></textarea>
      <button id="feedback-submit">Submit Feedback</button>
    </div>
    <!-- Plane UI -->
    <div id="plane-ui">
      <div id="red-buttons">
        <button class="red-button">1</button>
        <button class="red-button">2</button>
        <button class="red-button">3</button>
        <button class="red-button">4</button>
        <button class="red-button">5</button>
      </div>
      <div id="lever-container">
        <button id="run-lever">RUN</button>
      </div>
    </div>
  </div>
</div>

<!-- Editor CDNs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>

<!-- React Components & Serverless Integration -->
<script type="module">
import RegisterForm from './src/RegisterForm.jsx';
import LoginForm from './src/LoginForm.jsx';
import { NetlifySecrets } from './src/NetlifySecrets.jsx';

const secrets = await NetlifySecrets();
console.log("Secrets loaded:", secrets);

window.currentUser = null;

// Auth Forms
const authContainer = document.getElementById('auth-container');
const registerFormEl = RegisterForm({ onRegister: loadMyServers });
const loginFormEl = LoginForm({ onLogin: loadMyServers });
authContainer.appendChild(registerFormEl);
authContainer.appendChild(loginFormEl);

// Page Navigation
const homePage = document.getElementById('home-page');
const profilePage = document.getElementById('profile-page');
const editorPage = document.getElementById('editor-page');
document.getElementById('profile-btn').addEventListener('click', () => {
  homePage.classList.remove('active');
  profilePage.classList.add('active');
});
document.getElementById('back-home').addEventListener('click', () => {
  profilePage.classList.remove('active');
  homePage.classList.add('active');
});

// Create Server
document.getElementById('create-server-btn').addEventListener('click', async () => {
  if (!window.currentUser) return alert("Please login first.");
  const name = prompt("Enter server name:");
  if (!name) return;
  const res = await fetch("/.netlify/functions/publish-server", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ownerId: window.currentUser.id, name }),
  });
  const data = await res.json();
  if (data.success) loadMyServers();
  else alert(data.error);
});

// Load Servers
async function loadServers() {
  const res = await fetch("/.netlify/functions/get-servers");
  const servers = await res.json();
  const grid = document.getElementById('server-grid');
  grid.innerHTML = '';
  servers.forEach(server => {
    const div = document.createElement('div');
    div.className = 'server-card';
    div.textContent = `${server.name} by ${server.owner_name}`;
    div.onclick = () => openEditor(server);
    grid.appendChild(div);
  });
}

// Load My Servers
async function loadMyServers() {
  if (!window.currentUser) return;
  const res = await fetch("/.netlify/functions/get-servers");
  const servers = await res.json();
  const myDiv = document.getElementById('my-servers');
  myDiv.innerHTML = '';
  servers.filter(s => s.owner_id === window.currentUser.id).forEach(server => {
    const div = document.createElement('div');
    div.className = 'server-card';
    div.textContent = server.name;
    div.onclick = () => openEditor(server);
    myDiv.appendChild(div);
  });
}

// Open Editor
function openEditor(server) {
  homePage.classList.remove('active');
  profilePage.classList.remove('active');
  editorPage.classList.add('active');
  console.log("Opening server:", server);
  // TODO: populate your editors with server.html, server.css, server.js
}

// Initial load
loadServers();
</script>

</body>
</html>
